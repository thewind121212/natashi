version: '3'

vars:
  SOCKET_PATH: /tmp/music-playground.sock

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  run:debug:
    desc: Start all servers with DEBUG mode (audio plays to macOS speakers)
    cmds:
      - task: kill
      - |
        echo "=== Audio Playground (DEBUG MODE) ==="
        echo "Audio: PCM s16le 48kHz -> ffplay -> macOS speakers"
        echo ""
        echo "Go:      http://localhost:8180"
        echo "Node.js: http://localhost:3000"
        echo "Vite:    http://localhost:5173"
        echo ""
        echo "Press Ctrl+C to stop all servers"
        echo "=========================================="
        echo ""
      - |
        # Load env vars from app/.env for Go server
        set -a
        [ -f app/.env ] && source app/.env
        set +a
        npx concurrently --kill-others --names "Go,Node,Vite" --prefix-colors "cyan,green,magenta" --prefix "[{name}]" "go run cmd/playground/main.go" "cd app && DEBUG_AUDIO=1 npm run dev" "cd playground && npx vite --clearScreen false"

  run:bot:
    desc: Start Go + Node.js with Discord bot (reads from app/.env)
    cmds:
      - task: kill
      - |
        echo "=== Music Bot (Discord Mode) ==="
        echo "Discord bot will connect with BOT_TOKEN and GUILD_ID"
        echo ""
        echo "Go:      http://localhost:8180"
        echo "Node.js: http://localhost:3000"
        echo ""
        echo "Press Ctrl+C to stop all servers"
        echo "=========================================="
        echo ""
      - |
        # Load env vars from app/.env for Go server
        set -a
        [ -f app/.env ] && source app/.env
        set +a
        npx concurrently --kill-others --names "Go,Node" --prefix-colors "cyan,green" --prefix "[{name}]" "go run cmd/playground/main.go" "cd app && npm run dev"

  go:
    desc: Start only Go server
    cmds:
      - task: kill
      - go run cmd/playground/main.go

  node:
    desc: Start only Node.js server
    dir: app
    cmds:
      - npm run dev

  client:
    desc: Start only Vite client (React frontend)
    dir: playground
    cmds:
      - npx vite

  kill:
    desc: Kill any running playground servers
    cmds:
      - |
        # Kill by process name
        pkill -9 -f "go run cmd/playground" 2>/dev/null || true
        pkill -9 -f "cmd/playground/main" 2>/dev/null || true
        pkill -9 -f "app/dist/index.js" 2>/dev/null || true
        pkill -9 -f "node dist/index.js" 2>/dev/null || true
        pkill -9 -f "vite" 2>/dev/null || true
        pkill -9 -f "ffplay" 2>/dev/null || true
        # Kill by port (Go :8180, Node :3000, Vite :5173)
        # macOS: lsof, Linux: fuser
        if command -v lsof &>/dev/null; then
          lsof -ti:8180 | xargs kill -9 2>/dev/null || true
          lsof -ti:3000 | xargs kill -9 2>/dev/null || true
          lsof -ti:5173 | xargs kill -9 2>/dev/null || true
        elif command -v fuser &>/dev/null; then
          fuser -k 8180/tcp 2>/dev/null || true
          fuser -k 3000/tcp 2>/dev/null || true
          fuser -k 5173/tcp 2>/dev/null || true
        fi
        # Clean up socket
        rm -f {{.SOCKET_PATH}}
        echo "Killed existing servers"

  build:
    desc: Build everything
    cmds:
      - go build -o bin/playground cmd/playground/main.go
      - cd app && npm run build
      - cd playground && npm run build
      - echo "Build complete"

  install:
    desc: Install dependencies
    cmds:
      - cd app && npm install
      - cd playground && npm install
      - echo "Dependencies installed"

  clean:
    desc: Clean build artifacts
    cmds:
      - rm -rf bin/
      - rm -rf app/dist/
      - rm -rf playground/dist/
      - rm -f {{.SOCKET_PATH}}
      - echo "Cleaned"
